---
title: "How does an MRI take pictures?"
teaser: "some teaser text"
teaserImage: 'https://mattferraro.dev/images/caustics-engineering/2D_image.jpg'
date: '2022-04-22'
---

<!-- Magnetic Resonance Imaging is a technique for creating medically-useful images of the insides of bodies. Compared to something like X-rays, MRI:
- Produces no ionizing radiation
- Can distinguish soft tissue such as white matter from grey matter
- Can image *processes* such as oxygen absorption -->

<!-- But the downsides of MRIs are difficult to overlook:
1. Extremely expensive machines
2. High cost of operation
3. Stringent siting requirements -->


Magnetic Resonance Imaging allows us to take photos of the insides of our own brains. Here's mine:

[MRI photo of my brain]

In this post we'll learn how MRI works. We'll see why they are so flexible, powerful, and dangerous.

# Table of Contents

# Dipole Alignment

Let's start with a few basics about magnets.

Every magnet has a <span style={{color:"red"}}>North</span> pole and a <span style={{color:"blue"}}>South</span> pole which are inseparable so we call them Dipoles. Whenever two dipoles get close together, they feel a torque which tries to align them anti-parallel to each other:

<DipoleV2></DipoleV2>

By the way these visualizations are interactive. You can click and rotate the poles to see what happens when you change their orientations.

<!-- The pole on the left will stay at whatever angle you leave it. The pole on the right will respond to the resulting torques. You can also toggle the different visualization options if that's helpful for you. -->
<!-- 
A good mental model for magnetostatics is to break each dipole up into two monopoles, one with a <span style={{color:"red"}}>North</span> charge and one with a <span style={{color:"blue"}}>South</span> charge.

The monopoles then pull on each other with a force:

$$
F = -k \frac{q_1 q_2}{\bm{r}^2}
$$ -->

<!-- Such that like poles repels and unlike poles attract each other. -->

<!-- If you constrain the monopoles to be rigidly connected to each other they behave like bar magnets. This simple model lets us calculate net forces and torques to surprisingly high accuracy. -->

<!-- Said a little differently: The math in this simulation is identical to how you might simulate electrostatics using positive and negative electric charges. -->

<!-- Despite the simplicity of this model, it captures the phenomena we need to understand MRI. -->

If one dipole is much larger and stronger than the other, then the small dipole looks like it's just submerged in a uniform magnetic field.

Here I've simulated a huge, very strong dipole far away to the left of the screeen. Once again the dominant behavior is to align.

<DipoleV3></DipoleV3>

Notice that if you use the slider to make the external field stronger, the alignment torque gets stronger and the oscillation frequency gets faster.

<!-- The North end of a magnet is defined as the end that points toward the [Geographic North Pole](https://en.wikipedia.org/wiki/North_Pole) when used as a compass needle, which means that if you model the Earth as a big bar magnet, it's the South end of the bar that sits at Earth's [Magnetic North Pole](https://en.wikipedia.org/wiki/Geomagnetic_pole). -->

<!-- A compass needle is a small permanant magnet that tries to align itself with the Earth's magnetic field, exactly like this simulation. -->

<!-- This oscillation frequency is called the [Larmor Frequency](https://www.sciencedirect.com/topics/computer-science/larmor-frequency) and it is the single most important concept in all of Magnetic Resonance Imaging. -->

The frequency of the magnetic oscillation is something like:

$$
f_{magnet} = \frac{d}{I} \cdot B
$$

Where $d$ is the strength of the dipole, $I$ is its moment of inertia, and $B$ is the strength of the magnetic field it is submerged in.

Note that if two magnets have the same $\frac{d}{I}$ and are submerged in the same magnetic field, they will oscillate at the same frequency even if they are dramatically different in size or strength. The *ratio* is what matters.

In fact let's invent a term here and define $\frac{d}{I}$ as the **Magnetomoment Ratio**. It encapsulates the ratio of how strongly the magnet couples to the surrounding field vs how resistant it is to changing its orientation.

A Neodymium magnet has a high magnetomoment ratio and an Iron magnet has a weaker one.

<!-- 
$$
f_{Larmor} = g \cdot B
$$

Where $B$ is the strength of the magnetic field, and $g$ is the [gyromagnetic ratio](https://en.wikipedia.org/wiki/Gyromagnetic_ratio) of the magnet. -->

# Gyroscopic Precession

The second idea we need to understand is Precession and I know this feels like a non-sequitur, but toy gyroscopes are by far the most relatable example.

To understand why a gyroscope doesn't fall over, it's easiest to start by looking at its <span style={{"color":"#f08826"}}>angular momentum vector </span>:

<Gyroscope></Gyroscope>

<!-- TODO slider for $\phi$ -->

Without gravity, the <span style={{"color":"#f08826"}}>angular momentum vector </span> of the gyroscope remains fixed. As you increase the pull of gravity you create a <span style={{"color":"#00bf19"}}>gravitational force</span> that tries to pull the center of mass of the gyroscope to the ground. The distance from the center of mass to the pivot point forms a <span style={{"color":"#0095e6"}}>lever arm</span> which means that the gyroscope experiences a <span style={{"color":"#6500bd"}}>torque</span> which tries to rotate it towards the ground.

$$
\textcolor{#6500bd}{\tau} = \textcolor{#0095e6}{r} \times \textcolor{#00bf19}{F}
$$

To simulate what happens over time we add the <span style={{"color":"#6500bd"}}>torque vector</span> to the <span style={{"color":"#f08826"}}>angular momentum vector</span> but the two are always perpendicular so the angular momentum vector doesn't get shorter or longer, it just changes direction. Eventually the angular momentum vector swings back around to where it started. This process is called [precession](https://en.wikipedia.org/wiki/Precession) and however many times it precesses in a second is called its precession frequency.

<!-- This mental model equips us to make qualitative predictions:

- If we add mass to the gyroscope frame, the precession frequency should get faster
- If we spin the gyroscope faster, the precession frequency should get slower
- If we add more mass to the spinning center, then the angular momentum vector will get larger but the gravity torque will also get larger, so it depends! -->

Working out the math yields a formula for the precession frequency:

$$
f_{precession} = \frac{mr}{If} \cdot g
$$

Where $mr$ is the mass of the gyroscope times the length of the lever arm, and $If$ is the gyroscope's moment of inertia times the spinning part's frequency. $g$ is the gravitational acceleration.

We can invent another new word here and say that $\frac{mr}{If}$ is the **Gyrogravitational Ratio**. It encapsulates the ratio between how strongly gravity is trying to change the gyroscope's orientation vs how strongly the gyroscope resists having its orientation changed. The interplay between these two effects is what gives rise to the oscillation.

Note that nobody ever uses the words "Magnetomoment Ratio" or "Gyrogravitational Ratio", I made them up to illustrate the structural similarities between magnetic oscillation and angular precession. They are stepping stones for the next topic which fuses the two together.

<!-- TODO: talk about how the system loses energy over time due to friction and will eventually fall. Maybe simulate that and add a restart button? -->

# The Electron and The Nucleons

<!-- There is a system in nature which fuses the behavior of the two systems we've discussed above: The free nucleon in a uniform magnetic field. -->

Consider a lone proton, neutron or electron swimming in a strong magnetic field. How will it behave?

All three particles exhibit a quantum-mechanical property called **spin**, which means they all behave like tiny gyroscopes that can never cease spinning. They have angular momentum vectors pointing off in some direction so they resist changes in orientation.

Incidentally, they all have spin $\frac{1}{2} \hbar$ which means their angular momentum vectors are all the same length.

These tiny gyroscopes do not experience gravitational torques but they *do* feel alignment torque due to the background magnetic field!

The proton and neutron are each composed of quarks which carry electric charge and the electron is a point particle which carries charge. Spinning charges *are* current loops, so they induce their own magnetic dipoles.

Therefore all three _also_ behave like tiny bar magnets, desperately trying to align with the background field!

The resulting magnetic torque causes the subatomic particles to precess about the local magnetic field lines exactly like tiny gyroscopes.

[simulation of one of each in a uniform field, not mutually interacting, with variable phi]

Note that if you increase the tilt angle $\phi$ the precession frequency does not change.

<!-- This is a remarkable geometric coincidence which stems from the fact that the alignment torque increases as $\sin{\phi}$. -->

<!-- Over time energy is lost and the particles come to rest, still spinning, in alignment with the field. -->

In this situation the precession frequency is given a special name: the Larmor Frequency. It's governing equation is:

$$
f_{Larmor} = \frac{m}{L} \cdot B
$$

Where $m$ is the particle's magnetic moment, $L$ is the particle's angular momentum, and $B$ is the strength of the surrounding magnetic field.

This ratio $\frac{m}{L}$ is commonly referred to as the particle's **Gyromagnetic Ratio** and it is written as $\gamma$ (greek _gamma_).

$$
\gamma = \frac{m}{L}
$$

Unlike the two phrases I made up earlier, the [Gyromagnetic Ratio](https://en.wikipedia.org/wiki/Gyromagnetic_ratio) is an important concept in particle physics and you can look it up in reference tables.

<!-- Predicting a subatomic particle's gyromagnetic ratio from scratch involves quantum mechanics and is way outside the scope of this post but it involves finding the ratio between how strongly the magnetic field tries to change the particle's orientation vs how strongly the particle resists changes to its orientation. -->

<!-- Said another way: How magnety is it vs how gyroscopy is it? -->

For example we can look up the three particles in question:

| Particle | $\bold{\gamma}$ (MHz/Tesla) |
|:-- |:-- |
| proton | 42.577 |
| neutron | -29.164 |
| electron | 28024.951 |

This table tells us that a proton placed in a 1 Tesla magnetic field will precess at 42.577 MHz, and the governing equation tells us that the precession frequency responds linearly to changes in field strength.

Note that the proton and neutron have similar Larmor frequencies in a 1 T field, but the neutron precesses a little more slowly and in the opposite direction. 

The magnetic dipole moment of an electron is far stronger than the nucleons' so its precession frequency is much faster.

# Nuclide Response

A Nuclide is a specific configuration of an atomic nucleus. It is written like:

$$
^{7}_{3}\text{Li}^{}_{4}
$$

And this one is pronounced "Lithium 7, 3, 4". The letters at the center are the chemical symbol from the periodic table and the $7$ indicates the total number of nucleons in the nuclide. The $3$ indicates the number of protons and is redundant with the chemical symbol. The $4$ is also redundant because it tells you how many neutrons are in the nuclide, which is always equal to $7 - 3$.

When writing in shorthand you almost always omit the $4$ and the $3$. If you see something written as $^{7}\text{Li}$ it is understood that you're talking about $^{7}_{3}\text{Li}^{}_{4}$.

The simplest stable nuclide is $^1_{1}\text{H}_{0}$ which consists of just a single proton. We already know how this precesses in a magnetic field.

But what happens with $^4_{2}\text{He}_{2}$, which has two protons and two neutrons?

Remember from the first section that when you bring two bar magnets near each other they try to anti-align with each other. Nucleons will do the same thing.

The two protons will snap together in a pair such that their combined magnetic moment is zero. The two neutrons do the same and snap together, leaving the nucleus as a whole with zero magnetic moment and therefore no precession at all!

The same thing happens with $^{12}_{6}\text{C}_{6}$, $^{18}_{8}\text{O}_{10}$, and any other nuclide that has an even number of protons and an even number of neutrons. Consequently:

> Roughly $\frac{1}{4}$ of all nuclides do not possess magnetic moment and therefore do not precess at all.

So what happens with $^3_{1}\text{H}_{2}$, with its pair of neutrons and a lone proton?

The neutrons pair up and cancel out both their magnetic dipole moments and their angular momentums. The resulting nuclide behaves very much like a lone proton, with $\gamma = 45.415$ MHz/T.

A similar phenomenon occurs with $^3_{2}\text{H}_{1}$, which behaves very much like a lone neutron with $\gamma = -32.434$ MHz/T.

But what happens with $^2_{1}\text{H}_{1}$?

The proton and neutron snap together like tiny bar magnets but they are not equal in strength so they cancel somewhat but not completely. Their angular momentums are aligned and therefore add constructively. The nuclide has a weaker dipole and a larger angular momentum, so $^2_{1}\text{H}_{1}$  precesses quite slowly at just $\gamma = 6.535$ MHz/Tesla.

[diagram of the anti-alignment of dipoles but alignment of angular momemtum vectors]

It is possible to calculate the gyromagnetic ratio of any particle or nuclide from first principles using Quantum Electrodynamics and indeed this exact exercise applied to an [electron](https://en.wikipedia.org/wiki/Precision_tests_of_QED#Anomalous_magnetic_dipole_moments) is commonly held up as the single most convincing proof of that theory.

But that approach is only practical when dealing with extremely simple systems like lone electrons or muons. For heavy nuclides it is far better to rely on empirically measured [tables](https://web.archive.org/web/20180201154413/http://www-lcs.ensicaen.fr/pyPulsar/index.php/List_of_NMR_isotopes).

When applied to the muon (a particle just like the electron but heavier and short-lived), the empirical results for $\gamma$ do not agree perfectly with theory and this is considered by some to be a promising lead in the hunt for physics beyond the standard model.

# Hello

Right now you are sitting in the Earth's magnetic field and consequently all the protons and electrons of all Hydrogen atoms in your body are constantly trying to align themselves with it. They are at this moment oscillating around it at the Larmor frequency you would expect given the Earth's field strength.

This isn't just a theoretical example. You can [produce MRI images using this effect](https://pubmed.ncbi.nlm.nih.gov/2233218/). But I'm jumping ahead.

In a nucleus with two protons such as $^{4}_{2}\text{He}$, you might expect the two protons to both align with the external magnetic field and the resulting nucleus to have twice the magnetic moment, but the opposite happens:

[Simulation with two small dipoles in a larger uniform field with slide for separation distance, both spinning free]

As you pull the dipoles closer to each other, the torque driving them to anti-alignment is stronger than the torque driving them to align with the background field.

The lowest energy configuration is for the protons to form pairs which cancel each other out. The paired-off protons have no substantial interaction with the surrounding field and together feel no torque.

[interactive demo of two dipoles close to each other in an external field, allowing you to pause physics, rotate the dipoles, then resume physics to see what happens.]

Neutrons have a magnetic moment which is slightly weaker and carries the opposite sign, but they pair up in a similar way:

[diagram of neutrons paired up and cancelling]

Given that paired-up protons and neutrons cancel each other out, it follows that any nucleus with an even number of both will have no net magnetic dipole. Isotopes like $^{4}\text{He}$ and $^{12}\text{C}$ do not try to align with a magnetic field.

But any nucleus with an unpaired proton or unpaired neutron will have some net dipole! For example, $^{3}\text{He}$ contains two protons but only one neutron, so it feels a strong torque to align with a magnetic field. $^{7}\text{Li}$ contains four neutrons but only 3 protons, so it feels a strong torque as well.

A nucleas with both an unpaired proton _and_ an unpaired neutron will have a net dipole because protons and neutrons are not dipoles of equal strength. They cannot pair up properly and will not cancel out completely. $^{6}\text{Li}$ and $^{10}\text{B}$ are examples of this.

The stronger the net nuclear dipole, the stronger the torque will be. Two nuclides, each with one unpaired neutron, are demonstrated below:

129Xe - 54 Protons, 75 neutrons
3He - 2 Protons, 1 neutron

[Interactive with a uniform background field + two separated nuclides. The important phenomenon is that the Xe is "heavier"]

Despite these two nuclides exhibiting the same strength dipole and feeling identical alignment torque, the 129Xe is much heavier so it oscillates more slowly.

Every nuclide with net dipole moment also has an empirically measured "gyromagnetic ratio", which tells you that nuclide's oscillation frequency in a 1 Tesla magnetic field.

Light nuclides with strong dipoles such as $^{1}\text{H}$ and $^{3}\text{He}$ have high gyromagnetic ratios and will oscillate quickly. Heavy nuclides with weaker dipoles such as $^{129}\text{Xe}$ and $^{1}\text{H}$ have low gyromagnetic ratios and will oscillate slowly.

<!-- Remember from earlier that the oscillation frequency scales linearly with the strength of the magnetic field, so knowing the gyromagnetic ratio of a nuclide tells us how to find its oscillation frequency in *any* magnetic field. -->

The oscillation frequency, called the Larmor Frequency, is defined as:

$$
f_{larmor} = \gamma \cdot B
$$

Where $\gamma$ is the gyromagnetic ratio of the nuclide in question, and $B$ is the strength of the magnetic field in Teslas. The constant $\gamma$ therefore carries SI units of $\text{rad} \cdot \text{s}^{-1} \cdot \text{Tesla}^{-1}$ but for most practical applications we use $\frac{\text{MHz}}{\text{Tesla}}$.

| Nuclide | Gyromagnetic Ratio (MHz/Tesla) |
|:-- |:-- |
| $^{1}\text{H}$ | 42.577 |
| $^{2}\text{H}$ | 6.536 |
| $^{3}\text{H}$ | 45.415 |
| $^{3}\text{He}$ | -32.434 |
| $^{13}\text{C}$ | 10.708 |
| $^{14}\text{N}$ | 3.077 |
| $^{14}\text{N}$ | -4.316 |
| $^{57}\text{Fe}$ | 1.382 |
| $^{67}\text{Zn}$ | 2.669 |
| $^{129}\text{Xe}$ | -11.777 |
| $e$ | 28024.951 |

# Excitation and The Nuclear Magnetic Resonance

Electromagnetic waves contribute a time-varying magnetic field on top of the background field which causes the local field angle to wiggle:

[interactive demo split into three parts showing the background field, the time-varying field contributed by the wave, and the sum of the two. Allow user to toggle frequency and amplitude of the wave]

[optionally, have a toggle on that demo that shows field lines instead of vector directions?]

What does it look like when we put a nuclide in this field? In this simulation we've got a fixed background field of 1 Tesla and I've slowed down time by a factor of 10,000,000.

[interactive demo of the nuclide. Allow user to pick which nuclide from a dropdown, and allow them to control amplitude and frequency. damping rate is fixed and kinda high]

Notice that each nuclide can be made to resonate but only when the frequency of the electromagnetic wave matches the Larmor frequency of the nuclide. This is the phenomenon known as Nuclear Magnetic Resonance.

## Damping

<!-- Up until now our rotating dipoles have exhibited an unnamed damping torque that slows rotations. In a compass this is provided by friction. For nuclides, this is provided by their intrinsic coupling to the electromagnetic field. -->

If you place your hand in a pool full of water there is no way for you to shake it back and forth without also emanating waves which travel outward along the surface. The waves carry energy away from the excitation and the water pushes back against the movement of your hand, which feels like a damping force.

Given a magnetic dipole in free space, there is no way for it to oscillate without also emanating electromagnetic waves which travel outward through space. The electromagnetic field that permeates our universe acts like an endless pool and every charged particle acts like a hand dipped in its surface. To belabor the metaphor: moving a charged particle back and forth is like swashing your hand left and right. Rotating a dipole back and forth is like twisting your hand clockwise and counterclockwise.

The waves carry away energy at a rate proportional to the energy of the oscillation, which means that a dipole left to oscillate freely will see its energy decay exponentially, just as shown in the simulations so far.

# NMR Spectroscopy

Let's try an experiment where we place an unknown nuclide in a strong magnetic field, then hit it with electromagnetic waves of different frequencies.

For each frequency that we choose, we'll emit it for a few seconds to excite any resonance which might occur, then we'll abruptly stop emitting and start listening instead. If the nuclide was able to resonant, then we'll hear it give off waves.

[interactive with unknown nuclide and we can select a frequency, then hit "emit" and we'll see it emit, resonate or not, and then we stop emitting and show a plot of whatever waves it gives off]

Can you figure out what nuclide is being simulated just by analyzing the received waveform?

Spoiler alert: [Spoiler hidden: the nuclide is 13C, which is in the table]

This type of experiment is called Nuclear Magnetic Resonance Spectroscopy, or just NMR for short. The goal is to emit many different frequencies and then measure how much the nuclide responded to each frequency. The resulting graph, with frequency on the x-axis and response intensity on the y-axis, is called the spectrum of the nuclide.

[example spectrum]

There are ways to speed up the measurement process so that you don't need to wait and listen in between each individual frequency emission. One neat trick is to play what's called a "chirp":

[example of a chirp]

A chirp contains a little bit of energy at a bunch of different frequencies. The fourier transform of a chirp looks like this:

[fourier transform of a chirp]

Which shows us that a chirp contains equal energy at a whole range of frequencies!

We can emit one single chirp and listen for the response:

[interactive with just a "chirp" button, still showing the response with time on x axis. When response is done recording, show the FT of the response as well]

With a chirp we can measure an entire band of frequencies at once! The fourier transform of the response is the spectrum of our nuclide.

Devices that perform this experiment are called NMR Spectrometers and they are [available on ebay](https://www.ebay.com/sch/i.html?_nkw=NMR+spectrometer).

## Bulk Measurements

The simulation we've been playing with shows the receiver coil very close to the nuclide in question but this is not practical in applied experiments. 

An actual NMR Spectrometer permits glass vials full of samples and keeps all of the radio equipment outside of the sample.

[image of an actual NMR Spectrometer]

So, how do we sense the behavior of nuclides which are of order $10^{-15}$ meters across from outside the glass vial, several millimeters away?

The trick is to ensure that the entire sample is submerged in a very strong and uniform magnetic field. If that is the case, every nuclide inside will behave the exact same way and they will all oscillate in phase with each other. So long as they stay in phase they will sway in unison and the resulting waves that they emit all constructively interfere. This adds up to a signal we can easily measure with standard lab equipment.

Let's suppose the field strength is exactly 3 Tesla at one end of the glass vial. The Larmor frequency of $^{1}_{0}H$ will then be:

$$
3 \cdot 42.577 \space \text{MHz} = 127.731 \space \text{MHz}
$$

If the field strength increases linearly to 3.0001 Tesla at the other end of the vial, then the Larmor frequency on that end will be 

$$
3.0001 \cdot 42.577 \space \text{MHz} = 127.735 \space \text{MHz}
$$

The difference in Larmor frequencies is just $.004 \space \text{MHz}$ but that equals $4 \space \text{kHz}$ which means that the oscillating nuclides will drift out of phase with each other by $180 \degree$ in just $\frac{1}{8000}$ of a second.

You might expect that the two sides of the vial would be back in phase again another $\frac{1}{8000}$ of a second later and that's true, but what about the nuclides in the middle where the field strength is 3.00005 Tesla?

To find the resulting signal we have to sum up a continuum of frequencies in the range and the resulting waves will in general never come back into phase and the signal will be lost.

Lab NMR Spectrometers consequently need field uniformity of order 1 part per million.

## Field Uniformity 



These tiny machines generate very strong and very uniform magnetic fields such that every nuclide in the sample feels the exact same field strength to within a few parts per million. In a 3 Tesla field, that means the maximum field deviation is of order 3 microtesla.

For reference the Earth's magnetic field can range anywhere between 25,000 - 65,000 microtesla depending on the time of day, location on Earth, and solar weather.

Such machines consequently need to be shielded from Earth's magnetic field as well as any exogenous fields like wifi routers, microwaves, cell phone towers, etc. Passive shielding is easy to achieve by encasing the sample in sheets of mu-metal, permalloy, or other high-permeability metal.

The field uniformity is so important because it causes blurriness in the measured spectrum. 

## Superposition of Nuclides

## T1 vs T2 Signal

## Spin Echo?

## Chemistry Effects

# Imaging with NMR

## Slice Selection

## Column Selection

## Phase Effects


Separate post about magnetism? Field lines and energy density and Heusler Alloys and differences between Ferro/Para/Diamagnetism. Also Anti-Ferromagnetism, magnetic ionic compounds, geometrical frustration, Iron Catastrophe


Hyperpolarized 129Xe imaging: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3558952/

Larmor Frequency: https://www.sciencedirect.com/topics/computer-science/larmor-frequency

Mention that electrons do the same thing and that's also a kind of imaging!


Note that gyromagnetic ratio of electron is the single best measured and best predicted numbers in all of physics.

Talk about how a pendulum would have also been a great example to start with, but I didn't include it because a) pendulums are so boring that a lot of people would just stop reading and b) the ratio of a pendulum coupling to gravity to its resistence to change is always 1! This is a startling puzzle and leads to some very deep questions about intertia and gravity, but it would have been a distraction in a post about MRI.


If you want a classical explanation of why, remember that protons and neutrons are composed of charged particles called quarks. Each quark is both charged and spinning, so it produces a B field. In a neutron the total charges sum to zero, but the B fields do not sum to zero.

Talk about different spin states and how you could potentially excite the spin of a nuclide to create a spin isomer, then image just the spin isomers because their \gamma will be very different than those around them.

https://en.wikipedia.org/wiki/Spin_isomers_of_hydrogen